tasks.register('resetHost') {
    description = 'reset known host'
    group = "hosts"
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
                    "ssh-keygen -R ${target_host}"
        }
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
                    "ssh-keyscan -T 30 -H ${target_host} >> ~/.ssh/known_hosts"
        }
    }
}

// generic task to run ansible playbook
tasks.register('playbook') {
    group = "ansible"
    doLast {
    }
    if (project.hasProperty('ansible_playbook')) {
        exec {
            workingDir '.'
            commandLine 'ansible-playbook',  "${ansible_playbook}"
        }
    } else {
        println "need to set -ansible_playbook=[src relative path to playbook.yml file]"
    }
}

// generic task to run ansible playbook for given host
tasks.register('hostPlaybook') {
    group = "ansible"
    doLast {
    }
    if (project.hasProperty('ansible_playbook')) {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
                    'ansible-playbook ' +
                    '-i ' +
                    "${target_host}, " +
                    "${ansible_playbook}"
        }
    } else {
        println "need to set -Ptarget_host=[hostname] -Pansible_playbook=[src relative path to playbook.yml file]"
    }
}

tasks.register('kubeCtlr', GradleBuild) {
    description = 'run ansible kube controller script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/kube-ctlr.yml']
    tasks = ['hostPlaybook']
}

tasks.register('kubeNode', GradleBuild) {
    description = 'run ansible kube node script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/kube-node.yml']
    tasks = ['hostPlaybook']
}


// https://anthonynsimon.com/blog/kubernetes-cluster-raspberry-pi/#what-is-k3s-and-how-is-it-different-than-kubernetes
// http://armand.nz/notes/k3s/Kubernetes%20Cluster%20on%20Raspberry%20Pi%20using%20Ubuntu%2022.04%20LTS%20and%20K3s
tasks.register('kubeCommon', GradleBuild) {
    description = 'run ansible kube common script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/kube-common.yml']
    tasks = ['hostPlaybook']
}

// https://forums.raspberrypi.com/viewtopic.php?t=291640
// https://raspberrytips.com/disable-leds-on-raspberry-pi/
// https://lindevs.com/turn-off-built-in-leds-on-raspberry-pi/
// poe led no control
// TODO backup file creation causing errors
tasks.register('device', GradleBuild) {
    description = 'run ansible script to configure device settings'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/device-settings.yml']
    tasks = ['hostPlaybook']
}

// https://github.com/k3s-io/k3s/issues/1160
// https://medium.com/@bilsted/how-to-disable-traefik-and-metrics-server-on-k3s-b7dab4ca3aae
// https://qdnqn.com/k3s-remove-traefik/
tasks.register('rmTraefik', GradleBuild) {
    description = 'run ansible remove traefik controller script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/rem-traefik.yml']
    tasks = ['hostPlaybook']
    doLast {
        exec {
            workingDir '.'
            commandLine 'kubectl','-n','kube-system','delete','helmchart','traefik','traefik-crd'
        }
    }
}

// https://pimylifeup.com/raspberry-pi-nfs/
// https://www.phillipsj.net/posts/k3s-enable-nfs-storage/
tasks.register('nfsServer', GradleBuild) {
    description = 'run ansible nfs server script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/nfs-server.yml']
    tasks = ['playbook']
}

// https://pimylifeup.com/raspberry-pi-nfs-client/
// https://github.com/rancher/local-path-provisioner/blob/master/README.md#installation
tasks.register('nfsClient', GradleBuild) {
    description = 'run ansible nfs client script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/nfs-client.yml']
    tasks = ['playbook']
}

// opnsense CA root cert install
tasks.register('cacert', GradleBuild) {
    description = 'run ansible ca cert script'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/ca-cert.yml']
    tasks = ['hostPlaybook']
}

//add usb drive mounts to and folder binds
tasks.register('nodeStorage', GradleBuild) {
    description = 'add usb mounts to kube nodes'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/node-storage.yml']
    tasks = ['hostPlaybook']
}

tasks.register('rmk3s', GradleBuild) {
    description = 'remove k3s'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/rem-k3s.yml']
    tasks = ['hostPlaybook']
}

tasks.register('sites', GradleBuild) {
    description = 'deploy site configs'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/nginx.yml']
    tasks = ['hostPlaybook']
}

tasks.register('fixWait', GradleBuild) {
    description = 'fix wait online issue...'
    group = "ansible"
    startParameter.projectProperties = ['ansible_playbook':'src/ansible/systemd-networkd-wait-online.yml']
    tasks = ['hostPlaybook']
}
