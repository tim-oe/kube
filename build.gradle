tasks.register('loadsonar') {
    description = 'load postgres container to kube'
    group = "container"
    doLast {
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sonar-namespace.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/pg-config.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/pg-volume.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/pg-service.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/pg-deploy.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sq-config.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sq-volume.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sq-service.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sq-deploy.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/sonar/sq-ingress.yml'
        }
    }
}

tasks.register('deletesonar', GradleBuild) {
    description = 'delete postgres kube resources'
    group = "container"
    startParameter.projectProperties = ['namespace':'sonar']
    tasks = ['deleteAll']
}

tasks.register('loadjenkins') {
    description = 'load postgres container to kube'
    group = "container"
    doLast {
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/jenkins/jenkins-namespace.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/jenkins/jenkins-volume.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/jenkins/jenkins-deploy.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/jenkins/jenkins-service.yml'
        }
        exec {
            workingDir '.'
            commandLine 'kubectl', 'apply', '-f', 'src/jenkins/jenkins-ingress.yml'
        }
    }
}

tasks.register('deletejenkins', GradleBuild) {
    description = 'delete jenkins kube resources'
    group = "container"
    startParameter.projectProperties = ['namespace':'jenkins']
    tasks = ['deleteAll']
}

tasks.register('jenkinssecret') {
    description = 'get initial jenkins password'
    group = "container"
    doLast {
        if (project.hasProperty('jenkins_pod')) {
            exec {
                workingDir '.'
                commandLine 'bash', '-c',
                'kubectl -n=jenkins exec -it ' + "${jenkins_pod}" + ' -- cat /var/jenkins_home/secrets/initialAdminPassword'
            }
        } else {
            println "need to set -Pjenkins_pod=[pod name]"
        }
    }
}

tasks.register('deleteAll') {
    doLast {
        if (project.hasProperty('namespace')) {
            exec {
                workingDir '.'
                commandLine 'bash', '-c',
                    'kubectl ' + "-n=${namespace}" + ' delete all --all' 
            }
            exec {
                workingDir '.'
                commandLine 'bash', '-c',
                    'kubectl api-resources --verbs=list --namespaced -o name ' +
                    '| xargs -i kubectl ' + "-n=${namespace}" + ' delete {} --all'        
            }
            exec {
                workingDir '.'
                commandLine 'bash', '-c',
                    'kubectl delete namespace ' + "${namespace}" 
            }
        } else {
            println "need to set -Pnamespace=[resource namespace]"
        }
    }
}

// https://docs.aws.amazon.com/cli/latest/reference/eks/update-kubeconfig.html
tasks.register('awsConfig') {
    description = 'create kube config file for aws cluster'
    group = "container"
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
            'aws eks update-kubeconfig --name cicd'
        }
    }
}

// https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html
tasks.register('awsCluster') {
    description = 'create aws cluster'
    group = "container"
    doLast {
        exec {
            workingDir '.'
            commandLine 'bash', '-c',
            'aws eks create-cluster ' + 
            '--name cicd ' + 
            '--kubernetes-version 1.27 ' +
            '--role-arn arn:aws:iam::744686699669:role/EKSClusterRole ' +
            '--resources-vpc-config subnetIds=subnet-57a4b40e,subnet-756ec211,securityGroupIds=sg-9e97a0f9'
        }
    }
}
